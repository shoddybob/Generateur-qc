<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√©n√©rateur & Scanner QC</title>
    <script src="https://unpkg.com/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --bg: #f4f6f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin-bottom: 15px; font-size: 1.5rem; color: #2c3e50; }
        
        .grid { display: flex; flex-direction: column; gap: 15px; }
        .row { display: flex; gap: 15px; }
        .row > div { flex: 1; }
        
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
        
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; 
            font-size: 16px; box-sizing: border-box; background: #fff;
        }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { 
            flex: 1; padding: 15px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 700; font-size: 1rem; color: #fff;
        }
        .btn-gen { background: var(--success); }
        .btn-scan { background: var(--primary); }
        .btn-stop { background: #dc3545; display: none; margin-bottom: 10px; }

        #video-container { 
            display: none; position: relative; width: 100%; margin-bottom: 20px; 
            background: #000; border-radius: 8px; overflow: hidden;
        }
        video { width: 100%; height: auto; }

        #output { 
            margin-top: 30px; text-align: center; display: none; 
            background: #fff; padding: 15px; border-radius: 8px; border: 1px dashed #ccc;
        }
        canvas { max-width: 100%; height: auto !important; }
        .download-btn { background: #6c757d; margin-top: 15px; padding: 12px; width: 100%; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>QC Barcode Tool</h2>

    <button id="btnStop" class="btn-stop" onclick="stopScan()">Arr√™ter la cam√©ra</button>
    <div id="video-container">
        <video id="video" muted autoplay playsinline></video>
    </div>

    <div class="btn-group" style="margin-bottom: 20px; margin-top:0;">
        <button class="btn-scan" onclick="startScan()">üì∑ Scanner</button>
        <button class="btn-gen" onclick="generate()">‚öôÔ∏è G√©n√©rer</button>
    </div>

    <div class="grid">
        <div class="row">
            <div><label>Nom (DCS)</label><input type="text" id="lastName" placeholder="GINGRAS-BOUTIN"></div>
            <div><label>Pr√©nom (DAC)</label><input type="text" id="firstName" placeholder="KEVEN"></div>
        </div>
        
        <div><label>2e Pr√©nom (DAD)</label><input type="text" id="middleName"></div>
        
        <div class="row">
            <div><label>Naissance (DBB)</label><input type="text" id="dob" inputmode="numeric" placeholder="19890713"></div>
            <div><label>Sexe (DBC)</label><select id="sex"><option value="1">Masculin (1)</option><option value="2">F√©minin (2)</option></select></div>
        </div>

        <div class="row">
            <div><label>Taille (DAU)</label><input type="text" id="height" inputmode="numeric" placeholder="182"></div>
            <div>
                <label>Yeux (DAY)</label>
                <select id="eyes">
                    <option value="BLK">Noir (BLK)</option>
                    <option value="BLU" selected>Bleu (BLU)</option>
                    <option value="BRO">Brun (BRO)</option>
                    <option value="GRN">Vert (GRN)</option>
                    <option value="HAZ">Noisette (HAZ)</option>
                    <option value="GRY">Gris (GRY)</option>
                </select>
            </div>
        </div>

        <div><label>Adresse (DAG)</label><input type="text" id="address" placeholder="1910 AV BERGEMONT"></div>
        
        <div class="row">
            <div><label>Ville (DAI)</label><input type="text" id="city" placeholder="QUEBEC"></div>
            <div><label>Code Postal (DAK)</label><input type="text" id="zip" placeholder="G1J3T3"></div>
        </div>

        <div><label>Num√©ro de Permis (DAQ)</label><input type="text" id="dlNum" placeholder="G526513078902"></div>

        <div class="row">
            <div><label>√âmission (DBD)</label><input type="text" id="issueDate" inputmode="numeric" placeholder="20250813"></div>
            <div><label>Expiration (DBA)</label><input type="text" id="expiryDate" inputmode="numeric" placeholder="20290713"></div>
        </div>

        <div><label>No de Ref. (DCF)</label><input type="text" id="dd" placeholder="R4MVQLH36"></div>
    </div>

    <div id="output">
        <canvas id="barcodeCanvas"></canvas>
        <button class="download-btn" onclick="downloadImg()">T√©l√©charger l'image</button>
    </div>
</div>

<script>
    // --- PARTIE SCANNER ---
    let codeReader;
    
    async function startScan() {
        const videoContainer = document.getElementById('video-container');
        const btnStop = document.getElementById('btnStop');
        
        videoContainer.style.display = 'block';
        btnStop.style.display = 'block';

        codeReader = new ZXing.BrowserMultiFormatReader();
        
        try {
            // On demande la cam√©ra arri√®re par d√©faut
            const videoInputDevices = await codeReader.listVideoInputDevices();
            // Choix simple : la derni√®re cam√©ra trouv√©e est souvent la cam√©ra arri√®re sur mobile
            const selectedDeviceId = videoInputDevices.length > 0 ? videoInputDevices[videoInputDevices.length - 1].deviceId : undefined;

            console.log("D√©marrage cam√©ra...");
            
            // On se limite au format PDF_417 pour la performance
            const hints = new Map();
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.PDF_417]);

            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                if (result) {
                    console.log("Scan r√©ussi :", result.text);
                    stopScan();
                    parseAAMVA(result.text);
                    alert("Scan r√©ussi ! Formulaire rempli.");
                }
            });
        } catch (err) {
            console.error(err);
            alert("Erreur cam√©ra : " + err);
        }
    }

    function stopScan() {
        if (codeReader) {
            codeReader.reset();
        }
        document.getElementById('video-container').style.display = 'none';
        document.getElementById('btnStop').style.display = 'none';
    }

    // --- PARTIE PARSING AAMVA (D√©codage) ---
    function parseAAMVA(data) {
        // Fonction utilitaire pour extraire une valeur apr√®s un code (ex: DCS)
        // Regex cherche le code, capture jusqu'au saut de ligne
        const extract = (code) => {
            const regex = new RegExp(code + "(.*?)(?:\\n|\\r|$)", "i");
            const match = data.match(regex);
            return match ? match[1].trim() : "";
        };

        // Remplissage des champs
        const setVal = (id, val) => { if(val) document.getElementById(id).value = val; };
        
        setVal('lastName', extract('DCS'));
        setVal('firstName', extract('DAC'));
        setVal('middleName', extract('DAD'));
        setVal('dob', extract('DBB'));
        
        // Sexe : conversion code AAMVA vers Formulaire
        let sexCode = extract('DBC');
        if (sexCode === '1' || sexCode === 'M') document.getElementById('sex').value = "1";
        else if (sexCode === '2' || sexCode === 'F') document.getElementById('sex').value = "2";

        // Taille : on enl√®ve " cm" si pr√©sent
        let height = extract('DAU').replace(/[^0-9]/g, ''); 
        setVal('height', height);

        setVal('eyes', extract('DAY'));
        setVal('address', extract('DAG'));
        setVal('city', extract('DAI'));
        setVal('zip', extract('DAK'));
        setVal('dlNum', extract('DAQ'));
        setVal('issueDate', extract('DBD'));
        setVal('expiryDate', extract('DBA'));
        setVal('dd', extract('DCF'));
    }

    // --- PARTIE G√âN√âRATEUR (Existante) ---
    function generate() {
        const LF = '\x0A'; const RS = '\x1E'; const CR = '\x0D';
        const getVal = (id) => document.getElementById(id).value.toUpperCase().trim();

        let dlData = "DL";
        dlData += `DCA5${LF}DCBNONE${LF}DCDNONE${LF}`;
        dlData += `DBA${getVal('expiryDate')}${LF}`;
        dlData += `DCS${getVal('lastName')}${LF}DAC${getVal('firstName')}${LF}`;
        dlData += `DAD${getVal('middleName')}${LF}`;
        dlData += `DBD${getVal('issueDate')}${LF}`;
        dlData += `DBB${getVal('dob')}${LF}`;
        dlData += `DBC${getVal('sex')}${LF}`;
        dlData += `DAY${getVal('eyes')}${LF}`;
        dlData += `DAU${getVal('height')} cm${LF}`;
        dlData += `DAG${getVal('address')}${LF}`;
        dlData += `DAI${getVal('city')}${LF}`;
        dlData += `DAJQC${LF}`;
        dlData += `DAK${getVal('zip').replace(/\s/g, '')}${LF}`;
        dlData += `DAQ${getVal('dlNum')}${LF}`;
        dlData += `DCF${getVal('dd')}${LF}`;
        dlData += `DCGCAN${LF}DDEU${LF}DDFU${LF}DDGU${LF}`;

        let zqData = "ZQZQAPC${LF}BS1P03E458-01${LF}";

        const headerStatic = `@${LF}${RS}${CR}ANSI 604428100002`;
        const headerLen = headerStatic.length + 20;
        const dlOffset = headerLen.toString().padStart(4, '0');
        const dlLen = dlData.length.toString().padStart(4, '0');
        const zqOffset = (headerLen + dlData.length).toString().padStart(4, '0');
        const zqLen = zqData.length.toString().padStart(4, '0');

        const fullData = `${headerStatic}DL${dlOffset}${dlLen}ZQ${zqOffset}${zqLen}${dlData}${zqData}`;

        try {
            document.getElementById('output').style.display = 'block';
            bwipjs.toCanvas('barcodeCanvas', {
                bcid: 'pdf417', text: fullData, scale: 3, height: 10, cols: 9, eclevel: 5
            });
            setTimeout(() => document.getElementById('output').scrollIntoView({ behavior: 'smooth' }), 100);
        } catch (e) {
            alert("Erreur: " + e);
        }
    }

    function downloadImg() {
        const canvas = document.getElementById('barcodeCanvas');
        const link = document.createElement('a');
        link.download = 'permis_qc.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>

</body>
</html>
